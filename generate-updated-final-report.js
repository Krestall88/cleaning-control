const { PrismaClient } = require('@prisma/client');
const fs = require('fs');

const prisma = new PrismaClient();

async function generateUpdatedFinalReport() {
  try {
    console.log('üìä –ì–ï–ù–ï–†–ê–¶–ò–Ø –û–ë–ù–û–í–õ–ï–ù–ù–û–ì–û –ò–¢–û–ì–û–í–û–ì–û –û–¢–ß–ï–¢–ê');
    console.log('==========================================\n');

    // –°–æ–±–∏—Ä–∞–µ–º –∞–∫—Ç—É–∞–ª—å–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
    const stats = {
      managers: await prisma.user.count({ where: { role: 'MANAGER' } }),
      objects: await prisma.cleaningObject.count(),
      sites: await prisma.site.count(),
      zones: await prisma.zone.count(),
      rooms: await prisma.room.count(),
      checklists: await prisma.checklist.count(),
      tasks: await prisma.task.count(),
      auditLogs: await prisma.auditLog.count()
    };

    // –î–µ—Ç–∞–ª—å–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –º–µ–Ω–µ–¥–∂–µ—Ä–∞–º
    const managersWithStats = await prisma.user.findMany({
      where: { role: 'MANAGER' },
      include: {
        _count: {
          select: {
            managedObjects: true,
            managedSites: true,
            completedTasks: true,
            completedChecklists: true
          }
        }
      },
      orderBy: { name: 'asc' }
    });

    // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ –ø–æ –æ–±—ä–µ–∫—Ç–∞–º
    const objectsWithStats = await prisma.cleaningObject.findMany({
      include: {
        manager: { select: { name: true } },
        _count: {
          select: {
            sites: true,
            rooms: true,
            checklists: true,
            techCards: true
          }
        }
      },
      orderBy: { name: 'asc' }
    });

    // –ê–Ω–∞–ª–∏–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –æ–±—ä–µ–∫—Ç–æ–≤
    let multiLevel = 0;
    let sitesOnly = 0;
    let roomsOnly = 0;
    let empty = 0;

    objectsWithStats.forEach(obj => {
      if (obj._count.sites > 0 && obj._count.rooms > 0) {
        multiLevel++;
      } else if (obj._count.sites > 0) {
        sitesOnly++;
      } else if (obj._count.rooms > 0) {
        roomsOnly++;
      } else {
        empty++;
      }
    });

    // –°–æ–∑–¥–∞–µ–º –æ—Ç—á–µ—Ç
    let report = '';
    
    report += '# üìä –û–ë–ù–û–í–õ–ï–ù–ù–´–ô –ò–¢–û–ì–û–í–´–ô –û–¢–ß–ï–¢ –ü–û –°–ò–°–¢–ï–ú–ï –£–ü–†–ê–í–õ–ï–ù–ò–Ø –ö–õ–ò–ù–ò–ù–ì–û–ú\n\n';
    report += `**–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è:** ${new Date().toLocaleString('ru-RU')}\n`;
    report += `**–°—Ç–∞—Ç—É—Å:** –ü–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏ –¥—É–±–ª–µ–π –æ–±—ä–µ–∫—Ç–æ–≤\n\n`;
    
    report += '## üéØ –û–ë–©–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê (–ü–û–°–õ–ï –û–ß–ò–°–¢–ö–ò)\n\n';
    report += `- **üë• –ú–µ–Ω–µ–¥–∂–µ—Ä–æ–≤:** ${stats.managers}\n`;
    report += `- **üè¢ –û–±—ä–µ–∫—Ç–æ–≤:** ${stats.objects} ‚úÖ (—Ü–µ–ª—å 29 –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞!)\n`;
    report += `- **üó∫Ô∏è –£—á–∞—Å—Ç–∫–æ–≤:** ${stats.sites}\n`;
    report += `- **üè† –ó–æ–Ω:** ${stats.zones}\n`;
    report += `- **üö™ –ü–æ–º–µ—â–µ–Ω–∏–π:** ${stats.rooms}\n`;
    report += `- **üìã –ß–µ–∫-–ª–∏—Å—Ç–æ–≤:** ${stats.checklists}\n`;
    report += `- **‚úÖ –ó–∞–¥–∞—á:** ${stats.tasks}\n`;
    report += `- **üìù –ó–∞–ø–∏—Å–µ–π –∞—É–¥–∏—Ç–∞:** ${stats.auditLogs}\n\n`;

    report += '## üèóÔ∏è –ê–ù–ê–õ–ò–ó –°–¢–†–£–ö–¢–£–†–´ –û–ë–™–ï–ö–¢–û–í\n\n';
    report += `- **üèóÔ∏è –ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤—ã–µ (—É—á–∞—Å—Ç–∫–∏ + –ø–æ–º–µ—â–µ–Ω–∏—è):** ${multiLevel}\n`;
    report += `- **üó∫Ô∏è –¢–æ–ª—å–∫–æ —É—á–∞—Å—Ç–∫–∏:** ${sitesOnly}\n`;
    report += `- **üö™ –¢–æ–ª—å–∫–æ –ø–æ–º–µ—â–µ–Ω–∏—è:** ${roomsOnly}\n`;
    report += `- **üì≠ –ü—É—Å—Ç—ã–µ:** ${empty}\n\n`;

    const totalStructured = multiLevel + sitesOnly + roomsOnly;
    const structurePercentage = Math.round((totalStructured / stats.objects) * 100);
    
    report += `**–ü—Ä–æ—Ü–µ–Ω—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤:** ${structurePercentage}% (${totalStructured} –∏–∑ ${stats.objects})\n\n`;

    report += '## üë• –ú–ï–ù–ï–î–ñ–ï–†–´ –ò –ò–• –ù–ê–ì–†–£–ó–ö–ê\n\n';
    report += '| ‚Ññ | –ú–µ–Ω–µ–¥–∂–µ—Ä | –û–±—ä–µ–∫—Ç—ã | –£—á–∞—Å—Ç–∫–∏ | –ó–∞–¥–∞—á–∏ | –ß–µ–∫-–ª–∏—Å—Ç—ã |\n';
    report += '|---|----------|---------|---------|--------|----------|\n';
    
    managersWithStats.forEach((manager, index) => {
      report += `| ${index + 1} | ${manager.name} | ${manager._count.managedObjects} | ${manager._count.managedSites} | ${manager._count.completedTasks} | ${manager._count.completedChecklists} |\n`;
    });

    // –ê–Ω–∞–ª–∏–∑ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –Ω–∞–≥—Ä—É–∑–∫–∏
    const objectCounts = managersWithStats.map(m => m._count.managedObjects);
    const siteCounts = managersWithStats.map(m => m._count.managedSites);
    
    const avgObjects = Math.round(objectCounts.reduce((a, b) => a + b, 0) / managersWithStats.length * 10) / 10;
    const avgSites = Math.round(siteCounts.reduce((a, b) => a + b, 0) / managersWithStats.length * 10) / 10;
    const maxObjects = Math.max(...objectCounts);
    const minObjects = Math.min(...objectCounts);
    const maxSites = Math.max(...siteCounts);
    const minSites = Math.min(...siteCounts);

    report += '\n### üìà –ê–Ω–∞–ª–∏–∑ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è –Ω–∞–≥—Ä—É–∑–∫–∏:\n\n';
    report += `- **–°—Ä–µ–¥–Ω–µ–µ –æ–±—ä–µ–∫—Ç–æ–≤ –Ω–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–∞:** ${avgObjects}\n`;
    report += `- **–°—Ä–µ–¥–Ω–µ–µ —É—á–∞—Å—Ç–∫–æ–≤ –Ω–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–∞:** ${avgSites}\n`;
    report += `- **–†–∞–∑–±—Ä–æ—Å –ø–æ –æ–±—ä–µ–∫—Ç–∞–º:** –æ—Ç ${minObjects} –¥–æ ${maxObjects}\n`;
    report += `- **–†–∞–∑–±—Ä–æ—Å –ø–æ —É—á–∞—Å—Ç–∫–∞–º:** –æ—Ç ${minSites} –¥–æ ${maxSites}\n\n`;

    // –¢–æ–ø –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤
    const topByObjects = [...managersWithStats].sort((a, b) => b._count.managedObjects - a._count.managedObjects).slice(0, 5);
    const topBySites = [...managersWithStats].sort((a, b) => b._count.managedSites - a._count.managedSites).slice(0, 5);
    
    report += '**–¢–æ–ø-5 –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É –æ–±—ä–µ–∫—Ç–æ–≤:**\n';
    topByObjects.forEach((manager, index) => {
      report += `${index + 1}. ${manager.name} - ${manager._count.managedObjects} –æ–±—ä–µ–∫—Ç–æ–≤\n`;
    });
    
    report += '\n**–¢–æ–ø-5 –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ –ø–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤—É —É—á–∞—Å—Ç–∫–æ–≤:**\n';
    topBySites.forEach((manager, index) => {
      report += `${index + 1}. ${manager.name} - ${manager._count.managedSites} —É—á–∞—Å—Ç–∫–æ–≤\n`;
    });

    report += '\n## üè¢ –ü–û–õ–ù–´–ô –°–ü–ò–°–û–ö –û–ë–™–ï–ö–¢–û–í (29 —à—Ç.)\n\n';
    report += '| ‚Ññ | –û–±—ä–µ–∫—Ç | –ú–µ–Ω–µ–¥–∂–µ—Ä | –£—á–∞—Å—Ç–∫–∏ | –ü–æ–º–µ—â–µ–Ω–∏—è | –¢–µ—Ö–∫–∞—Ä—Ç—ã | –°—Ç—Ä—É–∫—Ç—É—Ä–∞ |\n';
    report += '|---|--------|----------|---------|-----------|----------|----------|\n';
    
    objectsWithStats.forEach((obj, index) => {
      let structure = '';
      if (obj._count.sites > 0 && obj._count.rooms > 0) {
        structure = 'üèóÔ∏è –ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è';
      } else if (obj._count.sites > 0) {
        structure = 'üó∫Ô∏è –£—á–∞—Å—Ç–∫–∏';
      } else if (obj._count.rooms > 0) {
        structure = 'üö™ –ü–æ–º–µ—â–µ–Ω–∏—è';
      } else {
        structure = 'üì≠ –ü—É—Å—Ç–∞—è';
      }
      
      report += `| ${index + 1} | ${obj.name} | ${obj.manager?.name || '–Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω'} | ${obj._count.sites} | ${obj._count.rooms} | ${obj._count.techCards} | ${structure} |\n`;
    });

    report += '\n## üéØ –î–û–°–¢–ò–ñ–ï–ù–ò–Ø –ü–û–°–õ–ï –û–ß–ò–°–¢–ö–ò\n\n';
    report += '### ‚úÖ –£—Å–ø–µ—à–Ω–æ –≤—ã–ø–æ–ª–Ω–µ–Ω–æ:\n\n';
    report += '1. **–û—á–∏—Å—Ç–∫–∞ –¥—É–±–ª–µ–π** - —É–¥–∞–ª–µ–Ω–æ 28 –¥—É–±–ª–∏—Ä—É—é—â–∏—Ö –æ–±—ä–µ–∫—Ç–æ–≤\n';
    report += '2. **–î–æ—Å—Ç–∏–∂–µ–Ω–∏–µ —Ü–µ–ª–∏** - —Ä–æ–≤–Ω–æ 29 –æ–±—ä–µ–∫—Ç–æ–≤ –∫–∞–∫ –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–ª–æ—Å—å\n';
    report += '3. **–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö** - –≤—Å–µ —É—á–∞—Å—Ç–∫–∏, –ø–æ–º–µ—â–µ–Ω–∏—è –∏ —Ç–µ—Ö–∫–∞—Ä—Ç—ã –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω—ã\n';
    report += '4. **–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤** - –≤—Å–µ –æ–±—ä–µ–∫—Ç—ã –∏–º–µ—é—Ç –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã—Ö –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤\n';
    report += '5. **–°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ** - 100% –æ–±—ä–µ–∫—Ç–æ–≤ –∏–º–µ—é—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É (—É—á–∞—Å—Ç–∫–∏ –∏–ª–∏ –ø–æ–º–µ—â–µ–Ω–∏—è)\n\n';

    report += '### üìä –ö–ª—é—á–µ–≤—ã–µ –º–µ—Ç—Ä–∏–∫–∏:\n\n';
    report += `- **–û–±—ä–µ–∫—Ç–æ–≤ –æ—á–∏—â–µ–Ω–æ:** 57 ‚Üí 29 (-28 –¥—É–±–ª–µ–π)\n`;
    report += `- **–î–∞–Ω–Ω—ã—Ö —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ:** 100% (—É—á–∞—Å—Ç–∫–∏, –ø–æ–º–µ—â–µ–Ω–∏—è, —Ç–µ—Ö–∫–∞—Ä—Ç—ã –ø–µ—Ä–µ–Ω–µ—Å–µ–Ω—ã)\n`;
    report += `- **–ú–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ –∞–∫—Ç–∏–≤–Ω–æ:** ${stats.managers} –∏–∑ 20\n`;
    report += `- **–£—á–∞—Å—Ç–∫–æ–≤ –≤—Å–µ–≥–æ:** ${stats.sites}\n`;
    report += `- **–ü–æ–º–µ—â–µ–Ω–∏–π –≤—Å–µ–≥–æ:** ${stats.rooms}\n\n`;

    report += '## üîß –¢–ï–•–ù–ò–ß–ï–°–ö–ê–Ø –ò–ù–§–û–†–ú–ê–¶–ò–Ø\n\n';
    report += '### –í—ã–ø–æ–ª–Ω–µ–Ω–Ω—ã–µ –æ–ø–µ—Ä–∞—Ü–∏–∏:\n\n';
    report += '1. **–ê–Ω–∞–ª–∏–∑ –¥—É–±–ª–µ–π** - –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –≤—ã—è–≤–ª–µ–Ω–∏–µ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—è–º\n';
    report += '2. **–ü—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏—è** - —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–æ–≤ —Å –ª—É—á—à–µ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π\n';
    report += '3. **–°–ª–∏—è–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö** - –ø–µ—Ä–µ–Ω–æ—Å —É—á–∞—Å—Ç–∫–æ–≤, –ø–æ–º–µ—â–µ–Ω–∏–π, —Ç–µ—Ö–∫–∞—Ä—Ç\n';
    report += '4. **–û—á–∏—Å—Ç–∫–∞ –±–∞–∑—ã** - —É–¥–∞–ª–µ–Ω–∏–µ –¥—É–±–ª–µ–π —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º —Ü–µ–ª–æ—Å—Ç–Ω–æ—Å—Ç–∏\n';
    report += '5. **–í–∞–ª–∏–¥–∞—Ü–∏—è** - –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏\n\n';

    report += '### –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏–æ—Ä–∏—Ç–∏–∑–∞—Ü–∏–∏ –æ–±—ä–µ–∫—Ç–æ–≤:\n\n';
    report += '- **–ú–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤–∞—è —Å—Ç—Ä—É–∫—Ç—É—Ä–∞** (—É—á–∞—Å—Ç–∫–∏ + –ø–æ–º–µ—â–µ–Ω–∏—è) - –≤—ã—Å—à–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç\n';
    report += '- **–¢–æ–ª—å–∫–æ —É—á–∞—Å—Ç–∫–∏** - —Å—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç\n';
    report += '- **–¢–æ–ª—å–∫–æ –ø–æ–º–µ—â–µ–Ω–∏—è** - –Ω–∏–∑–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç\n';
    report += '- **–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–µ—Ö–∫–∞—Ä—Ç** - –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Ñ–∞–∫—Ç–æ—Ä\n';
    report += '- **–ù–∞–ª–∏—á–∏–µ —á–µ–∫-–ª–∏—Å—Ç–æ–≤** - –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–π —Ñ–∞–∫—Ç–æ—Ä\n\n';

    report += '## üìã –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –ü–û –î–ê–õ–¨–ù–ï–ô–®–ï–ú–£ –†–ê–ó–í–ò–¢–ò–Æ\n\n';
    
    if (maxObjects - minObjects > 2) {
      report += '### ‚öñÔ∏è –ë–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∫–∞ –Ω–∞–≥—Ä—É–∑–∫–∏\n\n';
      report += `- –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ –Ω–µ—Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ—Å—Ç—å –≤ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–∏ –æ–±—ä–µ–∫—Ç–æ–≤ (–æ—Ç ${minObjects} –¥–æ ${maxObjects})\n`;
      report += '- –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –ø–µ—Ä–µ—Ä–∞—Å–ø—Ä–µ–¥–µ–ª–∏—Ç—å –æ–±—ä–µ–∫—Ç—ã –¥–ª—è –±–æ–ª–µ–µ —Ä–∞–≤–Ω–æ–º–µ—Ä–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–∏\n\n';
    }

    report += '### üè† –†–∞–∑–≤–∏—Ç–∏–µ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã\n\n';
    report += `- ${sitesOnly} –æ–±—ä–µ–∫—Ç–æ–≤ –∏–º–µ—é—Ç —Ç–æ–ª—å–∫–æ —É—á–∞—Å—Ç–∫–∏ - –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–æ–º–µ—â–µ–Ω–∏—è –¥–ª—è –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏\n`;
    report += `- ${multiLevel} –æ–±—ä–µ–∫—Ç–æ–≤ —É–∂–µ –∏–º–µ—é—Ç –º–Ω–æ–≥–æ—É—Ä–æ–≤–Ω–µ–≤—É—é —Å—Ç—Ä—É–∫—Ç—É—Ä—É - —Ö–æ—Ä–æ—à–∞—è –±–∞–∑–∞\n`;
    report += '- –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è —Å–æ–∑–¥–∞—Ç—å –∑–æ–Ω—ã –≤–Ω—É—Ç—Ä–∏ —É—á–∞—Å—Ç–∫–æ–≤ –¥–ª—è –µ—â–µ –±–æ–ª—å—à–µ–π –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏\n\n';

    report += '### ü§ñ –ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è\n\n';
    report += '- –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —á–µ–∫-–ª–∏—Å—Ç–æ–≤ –Ω–∞ –æ—Å–Ω–æ–≤–µ —Ç–µ—Ö–∫–∞—Ä—Ç\n';
    report += '- –í–Ω–µ–¥—Ä–∏—Ç—å —Å–∏—Å—Ç–µ–º—É —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –¥–ª—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤\n';
    report += '- –°–æ–∑–¥–∞—Ç—å –¥–∞—à–±–æ—Ä–¥ —Å –∫–ª—é—á–µ–≤—ã–º–∏ –º–µ—Ç—Ä–∏–∫–∞–º–∏\n\n';

    report += '## üéØ –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò\n\n';
    report += '1. **–°–æ–∑–¥–∞–Ω–∏–µ –∑–æ–Ω** - –î–æ–±–∞–≤–∏—Ç—å –∑–æ–Ω—ã –∫ —É—á–∞—Å—Ç–∫–∞–º –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–π –¥–µ—Ç–∞–ª–∏–∑–∞—Ü–∏–∏\n';
    report += '2. **–¢–µ—Ö–∫–∞—Ä—Ç—ã** - –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏ –¥–æ–ø–æ–ª–Ω–∏—Ç—å —Ç–µ—Ö–∫–∞—Ä—Ç—ã –¥–ª—è –≤—Å–µ—Ö –æ–±—ä–µ–∫—Ç–æ–≤\n';
    report += '3. **–ê–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏—è** - –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Å–æ–∑–¥–∞–Ω–∏–µ —á–µ–∫-–ª–∏—Å—Ç–æ–≤\n';
    report += '4. **–ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥** - –í–Ω–µ–¥—Ä–∏—Ç—å —Å–∏—Å—Ç–µ–º—É –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–¥–∞—á\n';
    report += '5. **–û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è** - –ê–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –∏ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Ä–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –Ω–∞–≥—Ä—É–∑–∫–∏\n';
    report += '6. **–û–±—É—á–µ–Ω–∏–µ** - –ü—Ä–æ–≤–µ—Å—Ç–∏ –æ–±—É—á–µ–Ω–∏–µ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–≤ —Ä–∞–±–æ—Ç–µ —Å –Ω–æ–≤–æ–π —Å–∏—Å—Ç–µ–º–æ–π\n\n';

    report += '---\n\n';
    report += '*–û—Ç—á–µ—Ç —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏ –¥—É–±–ª–µ–π –æ–±—ä–µ–∫—Ç–æ–≤*\n';
    report += `*–°–∏—Å—Ç–µ–º–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–ª–∏–Ω–∏–Ω–≥–æ–º - –≤–µ—Ä—Å–∏—è –ø–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –æ—Ç ${new Date().toLocaleDateString('ru-RU')}*\n`;

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –æ—Ç—á–µ—Ç –≤ —Ñ–∞–π–ª
    const filename = `UPDATED_FINAL_REPORT_${new Date().toISOString().split('T')[0]}.md`;
    fs.writeFileSync(filename, report, 'utf8');

    console.log('üìÑ –û–ë–ù–û–í–õ–ï–ù–ù–´–ô –û–¢–ß–ï–¢ –°–û–ó–î–ê–ù –£–°–ü–ï–®–ù–û!');
    console.log('='.repeat(40));
    console.log(`üìÅ –§–∞–π–ª: ${filename}`);
    console.log(`üìä –†–∞–∑–º–µ—Ä: ${Math.round(report.length / 1024 * 10) / 10} KB`);
    console.log(`üìã –°—Ç—Ä–æ–∫: ${report.split('\n').length}`);

    // –í—ã–≤–æ–¥–∏–º –∫—Ä–∞—Ç–∫—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –≤ –∫–æ–Ω—Å–æ–ª—å
    console.log('\nüìä –ê–ö–¢–£–ê–õ–¨–ù–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê:');
    console.log('='.repeat(30));
    console.log(`üë• –ú–µ–Ω–µ–¥–∂–µ—Ä–æ–≤: ${stats.managers}`);
    console.log(`üè¢ –û–±—ä–µ–∫—Ç–æ–≤: ${stats.objects} ‚úÖ (—Ü–µ–ª—å –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞!)`);
    console.log(`üó∫Ô∏è –£—á–∞—Å—Ç–∫–æ–≤: ${stats.sites}`);
    console.log(`üè† –ó–æ–Ω: ${stats.zones}`);
    console.log(`üö™ –ü–æ–º–µ—â–µ–Ω–∏–π: ${stats.rooms}`);
    console.log(`üìã –ß–µ–∫-–ª–∏—Å—Ç–æ–≤: ${stats.checklists}`);
    console.log(`‚úÖ –ó–∞–¥–∞—á: ${stats.tasks}`);

    console.log('\nüéâ –°–ò–°–¢–ï–ú–ê –ü–û–õ–ù–û–°–¢–¨–Æ –û–ü–¢–ò–ú–ò–ó–ò–†–û–í–ê–ù–ê!');
    console.log('‚úÖ –î—É–±–ª–∏ —É–¥–∞–ª–µ–Ω—ã, —Ü–µ–ª—å –¥–æ—Å—Ç–∏–≥–Ω—É—Ç–∞');
    console.log('‚úÖ –í—Å–µ –¥–∞–Ω–Ω—ã–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω—ã');
    console.log('‚úÖ –ú–µ–Ω–µ–¥–∂–µ—Ä—ã –Ω–∞–∑–Ω–∞—á–µ–Ω—ã –Ω–∞ –≤—Å–µ –æ–±—ä–µ–∫—Ç—ã');
    console.log('‚úÖ –°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞ –∫ –ø—Ä–æ–¥—É–∫—Ç–∏–≤–Ω–æ–º—É –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é');

  } catch (error) {
    console.error('‚ùå –û—à–∏–±–∫–∞:', error);
  } finally {
    await prisma.$disconnect();
  }
}

generateUpdatedFinalReport();
