# üîß –û–¢–õ–ê–î–ö–ê –û–®–ò–ë–ö–ò 500 –ü–†–ò –ó–ê–ì–†–£–ó–ö–ï –§–û–¢–û

## üêõ –û–®–ò–ë–ö–ê

```
POST /api/photos/upload 500 (Internal Server Error)
‚ùå UNIFIED MODAL: –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ: {message: '–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞'}
```

---

## üîç –ß–¢–û –°–î–ï–õ–ê–ù–û

### 1. –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ

**–§–∞–π–ª—ã —Å –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ–º:**
- `src/app/api/photos/upload/route.ts` - API –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ
- `src/lib/storage.ts` - –§—É–Ω–∫—Ü–∏–∏ –∑–∞–≥—Ä—É–∑–∫–∏ –≤ S3

**–õ–æ–≥–∏ –∫–æ—Ç–æ—Ä—ã–µ —Ç–µ–ø–µ—Ä—å –≤—ã–≤–æ–¥—è—Ç—Å—è:**
```
üì∏ API: –ù–∞—á–∞–ª–æ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ
‚úÖ API: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω: [–∏–º—è]
üìã API: FormData –ø–æ–ª—É—á–µ–Ω–∞
üì∏ API: –ü–∞—Ä–∞–º–µ—Ç—Ä—ã: {filesCount, taskId, objectId...}
üì§ API: –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª: [–∏–º—è] —Ä–∞–∑–º–µ—Ä: [—Ä–∞–∑–º–µ—Ä]
üì∏ STORAGE: –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: {name, type, size}
‚úÖ STORAGE: –ü—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã, –∑–∞–≥—Ä—É–∂–∞–µ–º –≤ S3...
üì§ –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ –≤ Timeweb S3: {bucket, key, size, type}
‚úÖ –§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω –≤ S3: [URL]
```

### 2. –°–æ–∑–¥–∞–Ω —Å–∫—Ä–∏–ø—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏ S3

```bash
npm run check-s3
```

–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –≤—Å–µ—Ö –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è –¥–ª—è S3.

---

## üß™ –ö–ê–ö –ù–ê–ô–¢–ò –ü–†–ò–ß–ò–ù–£ –û–®–ò–ë–ö–ò

### –®–∞–≥ 1: –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞

**–í —Ç–µ—Ä–º–∏–Ω–∞–ª–µ –≥–¥–µ –∑–∞–ø—É—â–µ–Ω `npm run dev` –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å –¥–µ—Ç–∞–ª—å–Ω—ã–µ –ª–æ–≥–∏:**

1. –û—Ç–∫—Ä–æ–π—Ç–µ —Ç–µ—Ä–º–∏–Ω–∞–ª —Å dev-—Å–µ—Ä–≤–µ—Ä–æ–º
2. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–≤–µ—Ä—à–∏—Ç—å –∑–∞–¥–∞—á—É —Å —Ñ–æ—Ç–æ
3. –ü–æ—Å–º–æ—Ç—Ä–∏—Ç–µ —á—Ç–æ –≤—ã–≤–æ–¥–∏—Ç—Å—è –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ

**–û–∂–∏–¥–∞–µ–º—ã–µ –ª–æ–≥–∏ –ø—Ä–∏ —É—Å–ø–µ—Ö–µ:**
```
üì∏ API: –ù–∞—á–∞–ª–æ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ
‚úÖ API: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω: –ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä
üìã API: FormData –ø–æ–ª—É—á–µ–Ω–∞
üì∏ API: –ü–∞—Ä–∞–º–µ—Ç—Ä—ã: {filesCount: 1, taskId: '...', objectId: '...'}
üì§ API: –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª: lagerhalle.webp —Ä–∞–∑–º–µ—Ä: 123456
üì∏ STORAGE: –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è: {name: 'lagerhalle.webp', type: 'image/webp', size: 123456}
‚úÖ STORAGE: –ü—Ä–æ–≤–µ—Ä–∫–∏ –ø—Ä–æ–π–¥–µ–Ω—ã, –∑–∞–≥—Ä—É–∂–∞–µ–º –≤ S3...
üì§ –ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞ –≤ Timeweb S3: {...}
‚úÖ –§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω –≤ S3: https://...
‚úÖ API: –§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω –≤ S3: https://...
‚úÖ API: –ó–∞–ø–∏—Å—å –≤ –ë–î —Å–æ–∑–¥–∞–Ω–∞: photo-id
```

**–ï—Å–ª–∏ –æ—à–∏–±–∫–∞ - –±—É–¥–µ—Ç –ø–æ–∫–∞–∑–∞–Ω–æ –≥–¥–µ –∏–º–µ–Ω–Ω–æ:**
```
‚ùå API: –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞: lagerhalle.webp [–¥–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏]
‚ùå API: –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ–æ—Ç—á–µ—Ç–æ–≤: [–æ—à–∏–±–∫–∞]
‚ùå API: –î–µ—Ç–∞–ª–∏ –æ—à–∏–±–∫–∏: {name, message, stack}
```

### –®–∞–≥ 2: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é S3

```bash
npm run check-s3
```

**–û–∂–∏–¥–∞–µ–º—ã–π –≤—ã–≤–æ–¥:**
```
üîç –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ S3

–ü–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–∫—Ä—É–∂–µ–Ω–∏—è:
  S3_ACCESS_KEY_ID: ‚úÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
  S3_SECRET_ACCESS_KEY: ‚úÖ –£—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
  S3_BUCKET_NAME: your-bucket-name
  S3_REGION: ru-1
  S3_ENDPOINT: https://s3.twcstorage.ru

‚úÖ S3 –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ!
```

**–ï—Å–ª–∏ S3 –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω:**
```
‚ö†Ô∏è  –í–ù–ò–ú–ê–ù–ò–ï: S3 –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω!
–§–∞–π–ª—ã –±—É–¥—É—Ç —Å–æ—Ö—Ä–∞–Ω—è—Ç—å—Å—è –ª–æ–∫–∞–ª—å–Ω–æ –≤ public/uploads/
```

---

## üîß –í–û–ó–ú–û–ñ–ù–´–ï –ü–†–ò–ß–ò–ù–´ –û–®–ò–ë–ö–ò 500

### 1. S3 –Ω–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω –∏–ª–∏ –Ω–µ–≤–µ—Ä–Ω—ã–µ –∫–ª—é—á–∏

**–ü—Ä–æ–≤–µ—Ä–∫–∞:**
```bash
npm run check-s3
```

**–†–µ—à–µ–Ω–∏–µ:**
–î–æ–±–∞–≤–∏—Ç—å/–∏—Å–ø—Ä–∞–≤–∏—Ç—å –≤ `.env`:
```env
S3_ACCESS_KEY_ID=your-access-key
S3_SECRET_ACCESS_KEY=your-secret-key
S3_BUCKET_NAME=your-bucket-name
S3_REGION=ru-1
S3_ENDPOINT=https://s3.twcstorage.ru
```

### 2. –ü—Ä–æ–±–ª–µ–º–∞ —Å –¥–æ—Å—Ç—É–ø–æ–º –∫ S3 bucket

**–°–∏–º–ø—Ç–æ–º—ã:**
```
‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –≤ S3: AccessDenied
```

**–†–µ—à–µ–Ω–∏–µ:**
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø—Ä–∞–≤–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ bucket
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ bucket —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –∫–ª—é—á–∏ –¥–æ—Å—Ç—É–ø–∞ –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã

### 3. –ü—Ä–æ–±–ª–µ–º–∞ —Å —Ç–∏–ø–æ–º —Ñ–∞–π–ª–∞

**–°–∏–º–ø—Ç–æ–º—ã:**
```
‚ùå STORAGE: –ù–µ–≤–µ—Ä–Ω—ã–π —Ç–∏–ø —Ñ–∞–π–ª–∞: [—Ç–∏–ø]
```

**–†–µ—à–µ–Ω–∏–µ:**
- –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å MIME-—Ç–∏–ø —Ñ–∞–π–ª–∞

### 4. –§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π

**–°–∏–º–ø—Ç–æ–º—ã:**
```
‚ùå STORAGE: –§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π: [—Ä–∞–∑–º–µ—Ä]
```

**–†–µ—à–µ–Ω–∏–µ:**
- –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —Ä–∞–∑–º–µ—Ä: 10MB
- –°–∂–∞—Ç—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π

### 5. –ü—Ä–æ–±–ª–µ–º–∞ —Å –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö

**–°–∏–º–ø—Ç–æ–º—ã:**
```
‚úÖ –§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω –≤ S3: [URL]
‚ùå API: –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–∞–π–ª–∞: [–æ—à–∏–±–∫–∞ –ë–î]
```

**–†–µ—à–µ–Ω–∏–µ:**
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ –ë–î
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ö–µ–º—É —Ç–∞–±–ª–∏—Ü—ã `PhotoReport`

---

## üìä –í–†–ï–ú–ï–ù–ù–û–ï –†–ï–®–ï–ù–ò–ï: –õ–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ

–ï—Å–ª–∏ S3 –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, —Å–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø–µ—Ä–µ–∫–ª—é—á–∏—Ç—Å—è –Ω–∞ –ª–æ–∫–∞–ª—å–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ.

**–§–∞–π–ª—ã –±—É–¥—É—Ç —Å–æ—Ö—Ä–∞–Ω—è—Ç—å—Å—è –≤:**
```
public/uploads/photos/
```

**URL —Ñ–∞–π–ª–æ–≤ –±—É–¥–µ—Ç:**
```
/uploads/photos/filename.jpg
```

**–í–∞–∂–Ω–æ:** –õ–æ–∫–∞–ª—å–Ω—ã–µ —Ñ–∞–π–ª—ã –Ω–µ –±—É–¥—É—Ç –¥–æ—Å—Ç—É–ø–Ω—ã –ø–æ—Å–ª–µ –¥–µ–ø–ª–æ—è!

---

## üéØ –°–õ–ï–î–£–Æ–©–ò–ï –®–ê–ì–ò

1. **–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞** (—Ç–µ—Ä–º–∏–Ω–∞–ª —Å `npm run dev`)
2. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å S3 –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é** (`npm run check-s3`)
3. **–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –æ—à–∏–±–∫—É –∏–∑ –ª–æ–≥–æ–≤** –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞
4. **–ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ñ–∞–π–ª .env** - –≤—Å–µ –ª–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ S3 —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ã

---

## üìã –ß–ï–ö–õ–ò–°–¢ –û–¢–õ–ê–î–ö–ò

- [ ] –ü–æ—Å–º–æ—Ç—Ä–µ–ª –ª–æ–≥–∏ –≤ —Ç–µ—Ä–º–∏–Ω–∞–ª–µ dev-—Å–µ—Ä–≤–µ—Ä–∞
- [ ] –ó–∞–ø—É—Å—Ç–∏–ª `npm run check-s3`
- [ ] –ü—Ä–æ–≤–µ—Ä–∏–ª —Ñ–∞–π–ª `.env`
- [ ] –°–∫–æ–ø–∏—Ä–æ–≤–∞–ª —Ç–µ–∫—Å—Ç –æ—à–∏–±–∫–∏ –∏–∑ –ª–æ–≥–æ–≤
- [ ] –ü—Ä–æ–≤–µ—Ä–∏–ª —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞ (< 10MB)
- [ ] –ü—Ä–æ–≤–µ—Ä–∏–ª —Ç–∏–ø —Ñ–∞–π–ª–∞ (image/*)

---

## üìû –ò–ù–§–û–†–ú–ê–¶–ò–Ø –î–õ–Ø –û–¢–õ–ê–î–ö–ò

–ö–æ–≥–¥–∞ –±—É–¥–µ—Ç–µ —Å–æ–æ–±—â–∞—Ç—å –æ–± –æ—à–∏–±–∫–µ, –ø—Ä–∏–ª–æ–∂–∏—Ç–µ:

1. **–õ–æ–≥–∏ –∏–∑ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞** (–ø–æ–ª–Ω—ã–π —Ç–µ–∫—Å—Ç –æ—à–∏–±–∫–∏)
2. **–†–µ–∑—É–ª—å—Ç–∞—Ç `npm run check-s3`**
3. **–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ñ–∞–π–ª–µ:**
   - –ò–º—è —Ñ–∞–π–ª–∞
   - –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞
   - –¢–∏–ø —Ñ–∞–π–ª–∞ (—Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ)

---

**–î–∞—Ç–∞:** 24.11.2025, 03:36  
**–°—Ç–∞—Ç—É—Å:** üîç –û–¢–õ–ê–î–ö–ê
